name: Agent Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  agent-review:
    name: Copilot Agent Review
    runs-on: ubuntu-latest
    # Skip for Dependabot PRs; for forks without COPILOT_GITHUB_TOKEN the install step will fail gracefully (continue-on-error)
    if: github.event.pull_request.user.login != 'dependabot[bot]'

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Get PR diff context
        id: diff
        run: |
          echo "Fetching PR #${{ github.event.pull_request.number }} diff..."
          gh pr diff ${{ github.event.pull_request.number }} --name-only > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run Code Review Agent
        run: |
          CHANGED=$(cat changed_files.txt | tr '\n' ', ')
          PROMPT="Review the changes in PR #${{ github.event.pull_request.number }} in repo ${{ github.repository }}. The changed files are: ${CHANGED}. Use your code-reviewer agent instructions. After review, post a comment on the PR with your findings."

          EXIT_CODE=0
          timeout --foreground --signal=TERM --kill-after=30s 300s \
            copilot --agent code-reviewer \
              --prompt "$PROMPT" \
              --allow-all-tools \
              --allow-all-paths < /dev/null 2>&1 || EXIT_CODE=$?

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::warning::Copilot agent review exited with code $EXIT_CODE (non-blocking)"
          fi
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
          CI: "true"
          NO_COLOR: "1"
          TERM: dumb
        continue-on-error: true  # Agent review is advisory, not blocking
