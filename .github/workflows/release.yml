name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Type check
        run: npx tsc --noEmit

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

      - name: Get changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" ${PREV_TAG}..HEAD)
          fi
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate AI release summary
        id: ai_summary
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          COMMITS="${{ steps.changelog.outputs.commits }}"

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$(jq -n --arg commits "$COMMITS" '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "You are a release notes writer for an open-source CLI tool called VidPipe - an AI-powered video content pipeline that auto-generates shorts, captions, social posts, and blog content from video recordings. Write concise, professional release notes. Group changes into categories: Features, Fixes, Improvements, Documentation. Use emoji prefixes. Keep it under 500 words."},
                {role: "user", content: ("Write release notes for these commits:\n\n" + $commits)}
              ],
              temperature: 0.3
            }')")

          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          if [ "$SUMMARY" = "null" ] || [ -z "$SUMMARY" ]; then
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## ðŸ¤– AI Summary

            ${{ steps.ai_summary.outputs.summary || steps.changelog.outputs.commits }}

            ---

            ## ðŸ“‹ Full Changelog
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
