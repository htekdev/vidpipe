import { initConfig } from '../../L1-infra/config/environment.js'
import { buildRealignPlan, executeRealignPlan } from '../../L3-services/scheduler/realign.js'

export interface RealignCommandOptions {
  platform?: string
  dryRun?: boolean
}

function formatDate(iso: string): string {
  const d = new Date(iso)
  return d.toLocaleDateString('en-US', {
    timeZone: 'America/Chicago',
    weekday: 'short',
    month: 'short',
    day: 'numeric',
  }) + ' ' + d.toLocaleTimeString('en-US', {
    timeZone: 'America/Chicago',
    hour: 'numeric',
    minute: '2-digit',
  })
}

const STATUS_ICON: Record<string, string> = {
  scheduled: 'ğŸ“…',
  draft: 'ğŸ“',
  cancelled: 'ğŸš«',
  failed: 'âŒ',
}

const PLATFORM_ICON: Record<string, string> = {
  tiktok: 'ğŸµ',
  youtube: 'â–¶ï¸',
  instagram: 'ğŸ“¸',
  linkedin: 'ğŸ’¼',
  twitter: 'ğŸ¦',
}

export async function runRealign(options: RealignCommandOptions = {}): Promise<void> {
  initConfig()

  console.log('\nğŸ”„ Realign Late Posts\n')

  if (options.platform) {
    console.log(`  Platform filter: ${options.platform}`)
  }
  if (options.dryRun) {
    console.log('  Mode: DRY RUN (no changes will be made)\n')
  }

  console.log('  Fetching posts from Late API...')
  const plan = await buildRealignPlan({ platform: options.platform })

  if (plan.totalFetched === 0) {
    console.log('  âœ… No posts found to realign.\n')
    return
  }

  console.log(`  Found ${plan.totalFetched} total post(s)`)
  if (plan.skipped > 0) {
    console.log(`  âœ… ${plan.skipped} post(s) already on valid slots â€” skipped`)
  }
  if (plan.unmatched > 0) {
    console.log(`  âš ï¸  ${plan.unmatched} post(s) had no local metadata match (defaulting to "short" clip type)`)
  }
  console.log(`  ${plan.posts.length} post(s) will be realigned`)
  if (plan.toCancel.length > 0) {
    console.log(`  ${plan.toCancel.length} post(s) will be cancelled (no matching schedule slots)`)
  }
  console.log()

  if (plan.posts.length === 0 && plan.toCancel.length === 0) {
    console.log('  âœ… Nothing to realign.\n')
    return
  }

  // Show posts to cancel
  if (plan.toCancel.length > 0) {
    console.log('  ğŸš« Posts to cancel:')
    const cancelByPlatform = new Map<string, typeof plan.toCancel>()
    for (const p of plan.toCancel) {
      if (!cancelByPlatform.has(p.platform)) cancelByPlatform.set(p.platform, [])
      cancelByPlatform.get(p.platform)!.push(p)
    }
    for (const [platform, posts] of cancelByPlatform) {
      const icon = PLATFORM_ICON[platform] ?? 'ğŸ“±'
      console.log(`    ${icon} ${platform} (${posts.length} posts) â€” ${posts[0].reason}`)
      for (const entry of posts.slice(0, 5)) {
        const preview = entry.post.content.slice(0, 50).replace(/\n/g, ' ')
        console.log(`      [${entry.clipType}] "${preview}..."`)
      }
      if (posts.length > 5) {
        console.log(`      ... and ${posts.length - 5} more`)
      }
    }
    console.log()
  }

  // Show posts to realign
  if (plan.posts.length > 0) {
    // Group by platform for display
    const byPlatform = new Map<string, typeof plan.posts>()
    for (const p of plan.posts) {
      if (!byPlatform.has(p.platform)) byPlatform.set(p.platform, [])
      byPlatform.get(p.platform)!.push(p)
    }

    for (const [platform, posts] of byPlatform) {
      const icon = PLATFORM_ICON[platform] ?? 'ğŸ“±'
      console.log(`  ${icon} ${platform} (${posts.length} posts)`)

      for (const entry of posts) {
        const statusIcon = STATUS_ICON[entry.post.status] ?? 'â“'
        const oldTime = entry.oldScheduledFor ? formatDate(entry.oldScheduledFor) : 'unscheduled'
        const newTime = formatDate(entry.newScheduledFor)
        const preview = entry.post.content.slice(0, 50).replace(/\n/g, ' ')
        console.log(`    ${statusIcon} [${entry.clipType}] "${preview}..."`)
        console.log(`       ${oldTime} â†’ ${newTime}`)
      }
      console.log()
    }
  }

  if (options.dryRun) {
    console.log('  ğŸ Dry run complete â€” no changes made.\n')
    return
  }

  console.log('  ğŸš€ Executing updates...\n')
  const result = await executeRealignPlan(plan)

  console.log(`  âœ… Updated: ${result.updated}`)
  if (result.cancelled > 0) {
    console.log(`  ğŸš« Cancelled: ${result.cancelled}`)
  }
  if (result.failed > 0) {
    console.log(`  âŒ Failed: ${result.failed}`)
    for (const err of result.errors) {
      console.log(`     ${err.postId}: ${err.error}`)
    }
  }
  console.log()
}
